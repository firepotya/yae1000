<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台 - 精工木作坊</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            padding: 80px 5% 2rem;
            min-height: 100vh;
            background-color: #f9f9f9;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-title {
            color: #2c3e50;
        }

        .logout-button {
            padding: 0.5rem 1rem;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        .upload-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .upload-form {
            display: grid;
            gap: 1rem;
        }

        .file-input-container {
            border: 2px dashed #ddd;
            padding: 2rem;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
        }

        .file-input-container:hover {
            border-color: #e67e22;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .preview-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .preview-item:hover img {
            transform: scale(1.05);
        }

        .preview-item .file-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .preview-item .remove-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-button {
            padding: 1rem;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .upload-button:hover {
            background-color: #d35400;
        }

        .gallery-sections {
            display: grid;
            gap: 2rem;
        }

        .gallery-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .gallery-section h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
            border-bottom: 2px solid #e67e22;
            padding-bottom: 0.5rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            position: relative;
            border-radius: 5px;
            overflow: hidden;
        }

        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .gallery-item .delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #e67e22;
            border-radius: 5px;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
        }

        .error-message {
            color: #e74c3c;
            margin: 0.5rem 0;
            display: none;
        }

        .success-message {
            color: #27ae60;
            margin: 0.5rem 0;
            display: none;
        }

        .gallery-item .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gallery-item .image-actions select {
            padding: 0.3rem;
            border-radius: 3px;
            border: none;
            background: white;
            color: #2c3e50;
            font-size: 0.8rem;
        }

        .gallery-item .image-actions button {
            padding: 0.3rem 0.5rem;
            border: none;
            border-radius: 3px;
            background: #e67e22;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .gallery-item .image-actions button:hover {
            background: #d35400;
        }

        .gallery-item .image-actions button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1>精工木作坊</h1>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">返回首頁</a></li>
            </ul>
        </nav>
    </header>

    <main class="admin-container">
        <div class="admin-header">
            <h2 class="admin-title">管理後台</h2>
            <button class="logout-button" onclick="logout()">登出</button>
        </div>

        <section class="upload-section">
            <h3>上傳新圖片</h3>
            <form class="upload-form" id="uploadForm">
                <div class="file-input-container" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #e67e22;"></i>
                    <p>點擊或拖曳圖片至此處</p>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                        支援的格式：JPG、PNG、GIF（最大 5MB）
                    </p>
                    <input type="file" id="fileInput" class="file-input" multiple accept="image/jpeg,image/png,image/gif">
                </div>
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="preview-container" id="previewContainer"></div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <label for="imageType" style="font-weight: bold;">圖片用途：</label>
                    <select id="imageType" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="portfolio">作品集圖片</option>
                        <option value="homepage">首頁圖片</option>
                    </select>
                </div>
                <button type="submit" class="upload-button">上傳圖片</button>
            </form>
        </section>

        <div class="gallery-sections">
            <section class="gallery-section">
                <h3>首頁圖片管理</h3>
                <div class="gallery-grid" id="homepageGrid">
                    <!-- 首頁圖片將通過 JavaScript 動態載入 -->
                </div>
            </section>

            <section class="gallery-section">
                <h3>作品集圖片管理</h3>
                <div class="gallery-grid" id="portfolioGrid">
                    <!-- 作品集圖片將通過 JavaScript 動態載入 -->
                </div>
            </section>
        </div>
    </main>

    <script>
        // 檢查登入狀態
        function checkLogin() {
            if (!localStorage.getItem('isAdminLoggedIn')) {
                window.location.href = 'admin-login.html';
            }
        }

        // 登出功能
        function logout() {
            localStorage.removeItem('isAdminLoggedIn');
            window.location.href = 'admin-login.html';
        }

        // 頁面載入時檢查登入狀態
        checkLogin();

        // 檔案預覽功能
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const uploadForm = document.getElementById('uploadForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif'];

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function validateFile(file) {
            if (!ALLOWED_TYPES.includes(file.type)) {
                throw new Error(`不支援的檔案類型：${file.type}`);
            }
            if (file.size > MAX_FILE_SIZE) {
                throw new Error(`檔案太大：${formatFileSize(file.size)}，最大允許 5MB`);
            }
            return true;
        }

        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            previewContainer.innerHTML = '';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            for (let file of files) {
                try {
                    validateFile(file);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="預覽圖">
                            <div class="file-info">
                                ${file.name}<br>
                                ${formatFileSize(file.size)}
                            </div>
                            <button type="button" class="remove-button" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        previewContainer.appendChild(previewItem);
                    }
                    reader.readAsDataURL(file);
                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                    fileInput.value = '';
                    return;
                }
            }
        });

        // 拖放功能
        const dropZone = document.querySelector('.file-input-container');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.style.borderColor = '#e67e22';
        }

        function unhighlight(e) {
            dropZone.style.borderColor = '#ddd';
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }

        // 上傳表單提交
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const imageType = document.getElementById('imageType').value;
            
            if (files.length === 0) {
                errorMessage.textContent = '請選擇要上傳的圖片';
                errorMessage.style.display = 'block';
                return;
            }

            // 驗證所有檔案
            for (let file of files) {
                try {
                    validateFile(file);
                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                    return;
                }
            }

            // 顯示進度條
            progressContainer.style.display = 'block';
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
            }, 200);

            try {
                // 上傳每個檔案
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const uploadedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
                        uploadedImages.push({
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name,
                            size: file.size,
                            type: imageType,
                            status: 'pending'
                        });
                        localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
                        
                        // 重新載入圖片列表
                        loadGallery();
                    };
                    reader.readAsDataURL(file);
                }

                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                successMessage.textContent = '圖片上傳成功！';
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';

                // 清空預覽和輸入
                previewContainer.innerHTML = '';
                fileInput.value = '';
            } catch (error) {
                clearInterval(interval);
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            }
        });

        // 載入圖片
        async function loadGallery() {
            try {
                const uploadedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
                
                // 載入首頁圖片
                const homepageImages = uploadedImages.filter(img => img.type === 'homepage');
                const homepageGrid = document.getElementById('homepageGrid');
                homepageGrid.innerHTML = '';
                
                if (homepageImages.length === 0) {
                    homepageGrid.innerHTML = '<p style="text-align: center; color: #666;">尚無首頁圖片</p>';
                } else {
                    homepageImages.forEach(image => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        galleryItem.innerHTML = `
                            <img src="${image.url}" alt="${image.name}">
                            <div class="image-actions">
                                <div class="file-info">
                                    ${image.name}<br>
                                    ${formatFileSize(image.size)}<br>
                                    狀態：${getStatusText(image.status)}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select onchange="updateImageStatus('${image.id}', this.value)">
                                        <option value="pending" ${image.status === 'pending' ? 'selected' : ''}>待處理</option>
                                        <option value="active" ${image.status === 'active' ? 'selected' : ''}>啟用</option>
                                        <option value="inactive" ${image.status === 'inactive' ? 'selected' : ''}>停用</option>
                                    </select>
                                    <button type="button" class="delete-button" onclick="deleteImage('${image.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        homepageGrid.appendChild(galleryItem);
                    });
                }

                // 載入作品集圖片
                const portfolioImages = uploadedImages.filter(img => img.type === 'portfolio');
                const portfolioGrid = document.getElementById('portfolioGrid');
                portfolioGrid.innerHTML = '';
                
                if (portfolioImages.length === 0) {
                    portfolioGrid.innerHTML = '<p style="text-align: center; color: #666;">尚無作品集圖片</p>';
                } else {
                    portfolioImages.forEach(image => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        galleryItem.innerHTML = `
                            <img src="${image.url}" alt="${image.name}">
                            <div class="image-actions">
                                <div class="file-info">
                                    ${image.name}<br>
                                    ${formatFileSize(image.size)}<br>
                                    狀態：${getStatusText(image.status)}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select onchange="updateImageStatus('${image.id}', this.value)">
                                        <option value="pending" ${image.status === 'pending' ? 'selected' : ''}>待處理</option>
                                        <option value="active" ${image.status === 'active' ? 'selected' : ''}>啟用</option>
                                        <option value="inactive" ${image.status === 'inactive' ? 'selected' : ''}>停用</option>
                                    </select>
                                    <button type="button" class="delete-button" onclick="deleteImage('${image.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        portfolioGrid.appendChild(galleryItem);
                    });
                }
            } catch (error) {
                console.error('載入圖片失敗:', error);
            }
        }

        // 獲取狀態文字
        function getStatusText(status) {
            switch(status) {
                case 'pending': return '待處理';
                case 'active': return '啟用中';
                case 'inactive': return '已停用';
                default: return status;
            }
        }

        // 更新圖片狀態
        async function updateImageStatus(imageId, status) {
            try {
                const uploadedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
                const imageIndex = uploadedImages.findIndex(img => img.id === imageId);
                
                if (imageIndex !== -1) {
                    uploadedImages[imageIndex].status = status;
                    
                    // 如果是首頁圖片，確保只有一張是啟用的
                    if (uploadedImages[imageIndex].type === 'homepage' && status === 'active') {
                        uploadedImages.forEach((img, index) => {
                            if (index !== imageIndex && img.type === 'homepage' && img.status === 'active') {
                                img.status = 'inactive';
                            }
                        });
                    }
                    
                    localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
                    loadGallery();
                }
            } catch (error) {
                console.error('更新狀態失敗:', error);
                alert('更新狀態失敗，請重試！');
            }
        }

        // 刪除圖片
        async function deleteImage(imageId) {
            if (confirm('確定要刪除這張圖片嗎？')) {
                try {
                    const uploadedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
                    const updatedImages = uploadedImages.filter(image => image.id !== imageId);
                    localStorage.setItem('uploadedImages', JSON.stringify(updatedImages));

                    // 重新載入圖片列表
                    loadGallery();
                    alert('圖片刪除成功！');
                } catch (error) {
                    console.error('刪除圖片失敗:', error);
                    alert('刪除圖片失敗，請重試！');
                }
            }
        }

        // 頁面載入時載入圖片
        loadGallery();
    </script>
</body>
</html> 